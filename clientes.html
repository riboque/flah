<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Clientes - Sistema de Monitoramento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            padding: 20px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        }
        .badge-online {
            background-color: #28a745;
        }
        .badge-offline {
            background-color: #dc3545;
        }
        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .stats-card i {
            font-size: 2rem;
            color: var(--primary-color);
        }
        .stats-card h3 {
            margin: 10px 0 5px;
            font-size: 1.8rem;
            color: #333;
        }
        .stats-card p {
            color: #666;
            margin: 0;
        }
        .search-box {
            position: relative;
        }
        .search-box input {
            padding-left: 40px;
            border-radius: 25px;
        }
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .loading.show {
            display: flex;
        }
        .loading .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
    </div>

    <div class="main-container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-white"><i class="fas fa-users me-2"></i>Gerenciamento de Clientes</h1>
                <p class="text-white-50">Sistema de Monitoramento - Banco de Dados Online</p>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4" id="statsRow">
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <i class="fas fa-users"></i>
                    <h3 id="statClientes">0</h3>
                    <p>Total Clientes</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <i class="fas fa-desktop"></i>
                    <h3 id="statDispositivos">0</h3>
                    <p>Dispositivos</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <i class="fas fa-signal"></i>
                    <h3 id="statOnline">0</h3>
                    <p>Online Agora</p>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card">
                    <i class="fas fa-network-wired"></i>
                    <h3 id="statConexoes">0</h3>
                    <p>Conexões</p>
                </div>
            </div>
        </div>

        <!-- Main Card -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Lista de Clientes</h5>
                <button class="btn btn-light" onclick="abrirModalNovoCliente()">
                    <i class="fas fa-plus me-1"></i> Novo Cliente
                </button>
            </div>
            <div class="card-body">
                <!-- Filtros -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="Buscar por nome, email, empresa..." 
                                   onkeyup="buscarClientes()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterAtivo" onchange="carregarClientes()">
                            <option value="">Todos</option>
                            <option value="true">Ativos</option>
                            <option value="false">Inativos</option>
                        </select>
                    </div>
                    <div class="col-md-3 text-end">
                        <button class="btn btn-outline-primary" onclick="carregarClientes()">
                            <i class="fas fa-sync"></i> Atualizar
                        </button>
                    </div>
                </div>

                <!-- Tabela -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Empresa</th>
                                <th>Telefone</th>
                                <th>Status</th>
                                <th>Dispositivos</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="clientesTable">
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                                    <p class="mt-2 mb-0">Carregando...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Paginação -->
                <nav>
                    <ul class="pagination justify-content-center" id="paginacao"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Modal Novo/Editar Cliente -->
    <div class="modal fade" id="modalCliente" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitulo">
                        <i class="fas fa-user-plus me-2"></i>Novo Cliente
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCliente">
                        <input type="hidden" id="clienteId">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nome *</label>
                                <input type="text" class="form-control" id="nome" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Telefone</label>
                                <input type="text" class="form-control" id="telefone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Empresa</label>
                                <input type="text" class="form-control" id="empresa">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Cargo</label>
                                <input type="text" class="form-control" id="cargo">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">CPF/CNPJ</label>
                                <input type="text" class="form-control" id="cpf_cnpj">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Endereço</label>
                                <input type="text" class="form-control" id="endereco">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Cidade</label>
                                <input type="text" class="form-control" id="cidade">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Estado</label>
                                <input type="text" class="form-control" id="estado">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">CEP</label>
                                <input type="text" class="form-control" id="cep">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Senha</label>
                                <input type="password" class="form-control" id="senha" 
                                       placeholder="Deixe em branco para manter a atual">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nível de Acesso</label>
                                <select class="form-select" id="nivel_acesso">
                                    <option value="usuario">Usuário</option>
                                    <option value="moderador">Moderador</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarCliente()">
                        <i class="fas fa-save me-1"></i>Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Detalhes -->
    <div class="modal fade" id="modalDetalhes" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user me-2"></i>Detalhes do Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detalhesConteudo">
                    <!-- Conteúdo carregado via JS -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configurações
        const API_BASE = '/api/db';
        let paginaAtual = 1;
        let debounceTimer;

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            carregarEstatisticas();
            carregarClientes();
            
            // Atualizar a cada 30 segundos
            setInterval(carregarEstatisticas, 30000);
        });

        // Funções de Loading
        function showLoading() {
            document.getElementById('loading').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        // Carregar Estatísticas
        async function carregarEstatisticas() {
            try {
                const resp = await fetch(`${API_BASE}/estatisticas`);
                const data = await resp.json();
                
                if (data.success) {
                    const stats = data.estatisticas;
                    document.getElementById('statClientes').textContent = stats.total_clientes || 0;
                    document.getElementById('statDispositivos').textContent = stats.total_dispositivos || 0;
                    document.getElementById('statOnline').textContent = stats.dispositivos_online || 0;
                    document.getElementById('statConexoes').textContent = stats.total_conexoes || 0;
                }
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // Carregar Clientes
        async function carregarClientes(pagina = 1) {
            paginaAtual = pagina;
            const busca = document.getElementById('searchInput').value;
            const ativo = document.getElementById('filterAtivo').value;
            
            let url = `${API_BASE}/clientes?pagina=${pagina}&por_pagina=10`;
            if (busca) url += `&busca=${encodeURIComponent(busca)}`;
            if (ativo) url += `&ativo=${ativo}`;
            
            try {
                const resp = await fetch(url);
                const data = await resp.json();
                
                if (data.success) {
                    renderizarTabela(data.clientes);
                    renderizarPaginacao(data);
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                document.getElementById('clientesTable').innerHTML = `
                    <tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados</td></tr>
                `;
            }
        }

        // Buscar com debounce
        function buscarClientes() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => carregarClientes(1), 300);
        }

        // Renderizar Tabela
        function renderizarTabela(clientes) {
            const tbody = document.getElementById('clientesTable');
            
            if (!clientes || clientes.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="8" class="text-center py-4 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Nenhum cliente encontrado</p>
                    </td></tr>
                `;
                return;
            }
            
            tbody.innerHTML = clientes.map(c => `
                <tr>
                    <td>${c.id}</td>
                    <td><strong>${escapeHtml(c.nome)}</strong></td>
                    <td>${escapeHtml(c.email)}</td>
                    <td>${escapeHtml(c.empresa || '-')}</td>
                    <td>${escapeHtml(c.telefone || '-')}</td>
                    <td>
                        <span class="badge ${c.ativo ? 'bg-success' : 'bg-secondary'}">
                            ${c.ativo ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td><span class="badge bg-info">${c.total_dispositivos || 0}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="verDetalhes(${c.id})" title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editarCliente(${c.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="confirmarExclusao(${c.id}, '${escapeHtml(c.nome)}')" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Renderizar Paginação
        function renderizarPaginacao(data) {
            const ul = document.getElementById('paginacao');
            if (data.paginas <= 1) {
                ul.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Anterior
            html += `<li class="page-item ${!data.tem_anterior ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="carregarClientes(${paginaAtual - 1})">Anterior</a>
            </li>`;
            
            // Páginas
            for (let i = 1; i <= data.paginas; i++) {
                if (i === 1 || i === data.paginas || (i >= paginaAtual - 2 && i <= paginaAtual + 2)) {
                    html += `<li class="page-item ${i === paginaAtual ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="carregarClientes(${i})">${i}</a>
                    </li>`;
                } else if (i === paginaAtual - 3 || i === paginaAtual + 3) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            // Próximo
            html += `<li class="page-item ${!data.tem_proxima ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="carregarClientes(${paginaAtual + 1})">Próximo</a>
            </li>`;
            
            ul.innerHTML = html;
        }

        // Modal Novo Cliente
        function abrirModalNovoCliente() {
            document.getElementById('formCliente').reset();
            document.getElementById('clienteId').value = '';
            document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-user-plus me-2"></i>Novo Cliente';
            new bootstrap.Modal(document.getElementById('modalCliente')).show();
        }

        // Editar Cliente
        async function editarCliente(id) {
            showLoading();
            try {
                const resp = await fetch(`${API_BASE}/clientes/${id}`);
                const data = await resp.json();
                
                if (data.success) {
                    const c = data.cliente;
                    document.getElementById('clienteId').value = c.id;
                    document.getElementById('nome').value = c.nome || '';
                    document.getElementById('email').value = c.email || '';
                    document.getElementById('telefone').value = c.telefone || '';
                    document.getElementById('empresa').value = c.empresa || '';
                    document.getElementById('cargo').value = c.cargo || '';
                    document.getElementById('cpf_cnpj').value = c.cpf_cnpj || '';
                    document.getElementById('endereco').value = c.endereco || '';
                    document.getElementById('cidade').value = c.cidade || '';
                    document.getElementById('estado').value = c.estado || '';
                    document.getElementById('cep').value = c.cep || '';
                    document.getElementById('nivel_acesso').value = c.nivel_acesso || 'usuario';
                    document.getElementById('observacoes').value = c.observacoes || '';
                    document.getElementById('senha').value = '';
                    
                    document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-user-edit me-2"></i>Editar Cliente';
                    new bootstrap.Modal(document.getElementById('modalCliente')).show();
                }
            } catch (error) {
                alert('Erro ao carregar cliente');
            } finally {
                hideLoading();
            }
        }

        // Salvar Cliente
        async function salvarCliente() {
            const id = document.getElementById('clienteId').value;
            const dados = {
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                telefone: document.getElementById('telefone').value,
                empresa: document.getElementById('empresa').value,
                cargo: document.getElementById('cargo').value,
                cpf_cnpj: document.getElementById('cpf_cnpj').value,
                endereco: document.getElementById('endereco').value,
                cidade: document.getElementById('cidade').value,
                estado: document.getElementById('estado').value,
                cep: document.getElementById('cep').value,
                nivel_acesso: document.getElementById('nivel_acesso').value,
                observacoes: document.getElementById('observacoes').value
            };
            
            const senha = document.getElementById('senha').value;
            if (senha) dados.senha = senha;
            
            showLoading();
            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `${API_BASE}/clientes/${id}` : `${API_BASE}/clientes`;
                
                const resp = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                
                const result = await resp.json();
                
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('modalCliente')).hide();
                    carregarClientes(paginaAtual);
                    carregarEstatisticas();
                    alert(result.message);
                } else {
                    alert('Erro: ' + result.error);
                }
            } catch (error) {
                alert('Erro ao salvar cliente');
            } finally {
                hideLoading();
            }
        }

        // Ver Detalhes
        async function verDetalhes(id) {
            showLoading();
            try {
                const resp = await fetch(`${API_BASE}/clientes/${id}`);
                const data = await resp.json();
                
                if (data.success) {
                    const c = data.cliente;
                    document.getElementById('detalhesConteudo').innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-muted">Informações Pessoais</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>Nome:</strong></td><td>${escapeHtml(c.nome)}</td></tr>
                                    <tr><td><strong>Email:</strong></td><td>${escapeHtml(c.email)}</td></tr>
                                    <tr><td><strong>Telefone:</strong></td><td>${escapeHtml(c.telefone || '-')}</td></tr>
                                    <tr><td><strong>CPF/CNPJ:</strong></td><td>${escapeHtml(c.cpf_cnpj || '-')}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted">Empresa</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>Empresa:</strong></td><td>${escapeHtml(c.empresa || '-')}</td></tr>
                                    <tr><td><strong>Cargo:</strong></td><td>${escapeHtml(c.cargo || '-')}</td></tr>
                                    <tr><td><strong>Nível:</strong></td><td><span class="badge bg-primary">${c.nivel_acesso}</span></td></tr>
                                    <tr><td><strong>Status:</strong></td><td><span class="badge ${c.ativo ? 'bg-success' : 'bg-secondary'}">${c.ativo ? 'Ativo' : 'Inativo'}</span></td></tr>
                                </table>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6 class="text-muted">Endereço</h6>
                                <p>${escapeHtml(c.endereco || '-')}, ${escapeHtml(c.cidade || '-')} - ${escapeHtml(c.estado || '-')}, CEP: ${escapeHtml(c.cep || '-')}</p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6 class="text-muted">Datas</h6>
                                <p><small><strong>Cadastro:</strong> ${formatarData(c.data_cadastro)}</small></p>
                                <p><small><strong>Último acesso:</strong> ${formatarData(c.ultimo_acesso)}</small></p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted">Estatísticas</h6>
                                <p><i class="fas fa-desktop me-1"></i> ${c.total_dispositivos || 0} dispositivos</p>
                            </div>
                        </div>
                        ${c.observacoes ? `<div class="mt-3"><h6 class="text-muted">Observações</h6><p>${escapeHtml(c.observacoes)}</p></div>` : ''}
                    `;
                    new bootstrap.Modal(document.getElementById('modalDetalhes')).show();
                }
            } catch (error) {
                alert('Erro ao carregar detalhes');
            } finally {
                hideLoading();
            }
        }

        // Confirmar Exclusão
        function confirmarExclusao(id, nome) {
            if (confirm(`Tem certeza que deseja excluir o cliente "${nome}"?\n\nEsta ação irá desativar o cliente.`)) {
                excluirCliente(id);
            }
        }

        // Excluir Cliente
        async function excluirCliente(id) {
            showLoading();
            try {
                const resp = await fetch(`${API_BASE}/clientes/${id}`, { method: 'DELETE' });
                const result = await resp.json();
                
                if (result.success) {
                    carregarClientes(paginaAtual);
                    carregarEstatisticas();
                    alert('Cliente excluído com sucesso');
                } else {
                    alert('Erro: ' + result.error);
                }
            } catch (error) {
                alert('Erro ao excluir cliente');
            } finally {
                hideLoading();
            }
        }

        // Utilitários
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatarData(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleString('pt-BR');
        }
    </script>
</body>
</html>
